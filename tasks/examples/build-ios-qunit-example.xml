<project name="qunit-ios" basedir="../../">

<!-- #DEFINES -->

    <!-- location of qunit -->
    <property name="qunit-www" value="${basedir}/lib/www"/>
    <!-- location of tests -->
    <property name="mobile-spec-www" value="${basedir}/lib/mobile-spec/"/>
    <!-- location to binar files needed for running tests -->
    <property name="bin-dir" value="${basedir}/bin"/>
    <!-- temporary storage gets cleaned on each run -->
    <property name="tmp-dir" value="${basedir}/tmp" />
    <property name="tmp-www" value="${basedir}/tmp/www"/>

    <!-- iphone project specific defines -->
    <property name="iphone-dir" value="${basedir}/iphone"/>
    <property name="iphone-assets" value="${iphone-dir}/www"/>
    <property name="iphone-project" value="iphone.xcodeproj" />
    <property name="iphone-app-name" value="iphone" />
    <property name="iphone-build-path" value="${iphone-dir}/tmp" />

    <!-- iphone simulator directory -->
    <property name="iphone-simulator" value="/Developer/Platforms/iPhoneSimulator.platform/Developer/Applications/iPhone Simulator.app/Contents/MacOS/iPhone Simulator" />



    <target name="clean-tmp">
        <delete dir="${tmp-dir}/"/>
    </target>

    <target name="prepare-tmp">
        <mkdir dir="${tmp-dir}"/>
        <chmod dir="${tmp-dir}" perm="777"/>
        <mkdir dir="${tmp-www}"/>
    </target>

    <target name="prepare-assets">
        <exec executable="${bin-dir}/reconfigure.php" dir="${basedir}" failonerror="true">
        </exec>
        <copy todir="${tmp-www}" failonerror="true">
            <fileset dir="${mobile-spec-www}">
                <exclude name="LICENSE"/>
                <exclude name="README.md"/>
                <exclude name="index.html"/>
                <exclude name="qunit.css"/>
                <exclude name="qunit.js"/>
            </fileset>
        </copy>
        <copy file="${qunit-www}/jquery.js"    todir="${tmp-www}"/>
        <copy file="${qunit-www}/qunit.js"    todir="${tmp-www}"/>
        <copy file="${qunit-www}/qunit.css"   todir="${tmp-www}"/>
        <copy file="${qunit-www}/qunitXML.js" todir="${tmp-www}"/>
        <copy file="lib/iphone-phonegap/phonegap.js" todir="${tmp-www}"/>
    </target>

    <target name="clean-ios">
        <delete dir="${iphone-assets}" />
        <delete dir="${iphone-build-path}"/>
    </target>

    <target name="prepare-ios">
        <mkdir dir="${iphone-assets}"/>
        <mkdir dir="${iphone-build-path}"/>
        <copy todir="${iphone-assets}" failonerror="true">
            <fileset dir="${tmp-www}" />
        </copy>
    </target>

    <target name="build-ios">
        <exec executable="xcodebuild" dir="${basedir}" failonerror="true">
            <arg value="-project"/>
            <arg value="${iphone-dir}/${iphone-project}"/>
            <arg value="-configuration" />
            <arg value="Debug"/>
            <arg value="-target"/>
            <arg value="iphone"/>
            <arg value="-sdk"/>
            <arg value="iphonesimulator4.2"/>
            <arg value="CONFIGURATION_BUILD_DIR=${iphone-build-path}"/>
        </exec>
    </target>

    <target name="emulate-ios" depends="clean-tmp, prepare-tmp, prepare-assets, clean-ios, prepare-ios, build-ios">
        <exec executable="${bin-dir}/testRunner.php" dir="${basedir}">
            <arg value="-o" />
            <arg value="${iphone-build-path}/${iphone-app-name}.app/www/server.js" />
            <arg value="-u"/>
            <arg value="http://localhost/capture.php" />
            <arg value="-b" />
            <arg value="${iphone-simulator}" />
            <arg value="--args"/>
            <arg value="-SimulateApplication" />
            <arg value="${iphone-dir}/tmp/iphone.app/iphone" />
        </exec>
        <exec executable="${bin-dir}/killiPhone.php" dir="${basedir}" failonerror="true">
            <arg value="${iphone-app-name}"/>
        </exec>
    </target>

</project>
